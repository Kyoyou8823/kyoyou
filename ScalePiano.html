<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>世界の音階 聴き比べアプリ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            touch-action: manipulation; /* ダブルタップズーム防止など */
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* スクロールバーのカスタマイズ */
        .custom-scrollbar::-webkit-scrollbar {
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const Play = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
        );
        const Square = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>
        );
        const Music = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
        );
        const Volume2 = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
        );
        const Info = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
        );
        const Mic = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
        );
        const Trash2 = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
        );

        const MusicalScalesApp = () => {
            const [activeScale, setActiveScale] = useState('major');
            const [waveform, setWaveform] = useState('triangle');
            const [volume, setVolume] = useState(0.3);
            const [playingNote, setPlayingNote] = useState(null); // For Scale Mode visual feedback
            const [playingPianoKey, setPlayingPianoKey] = useState(null); // For Piano Mode visual feedback
            const [mode, setMode] = useState('scale'); // 'scale' or 'piano'
            
            // Recording State
            const [isRecording, setIsRecording] = useState(false);
            const [recordingStartTime, setRecordingStartTime] = useState(null);
            const [currentRecording, setCurrentRecording] = useState([]);
            const [recordings, setRecordings] = useState([]);

            const audioContextRef = useRef(null);

            // スケールデータ
            const scales = {
                major: {
                    id: 'major',
                    name: '西洋 (ドレミ)',
                    description: '学校で習う一般的な長音階（メジャースケール）。',
                    color: 'bg-blue-500',
                    notes: [
                        { name: 'ド', pitch: 'C', freq: 261.63 },
                        { name: 'レ', pitch: 'D', freq: 293.66 },
                        { name: 'ミ', pitch: 'E', freq: 329.63 },
                        { name: 'ファ', pitch: 'F', freq: 349.23 },
                        { name: 'ソ', pitch: 'G', freq: 392.00 },
                        { name: 'ラ', pitch: 'A', freq: 440.00 },
                        { name: 'シ', pitch: 'B', freq: 493.88 },
                        { name: 'ド(高)', pitch: 'C', freq: 523.25 },
                    ]
                },
                okinawa: {
                    id: 'okinawa',
                    name: '沖縄 (琉球音階)',
                    description: '「レ」と「ラ」を抜いた5音音階。',
                    color: 'bg-orange-500',
                    notes: [
                        { name: 'ド', pitch: 'C', freq: 261.63 },
                        { name: 'ミ', pitch: 'E', freq: 329.63 },
                        { name: 'ファ', pitch: 'F', freq: 349.23 },
                        { name: 'ソ', pitch: 'G', freq: 392.00 },
                        { name: 'シ', pitch: 'B', freq: 493.88 },
                        { name: 'ド(高)', pitch: 'C', freq: 523.25 },
                    ]
                },
                china: {
                    id: 'china',
                    name: '中国 (五声音階)',
                    description: '「ファ」と「シ」を抜いた5音音階。',
                    color: 'bg-red-600',
                    notes: [
                        { name: '宮', pitch: 'C', freq: 261.63 },
                        { name: '商', pitch: 'D', freq: 293.66 },
                        { name: '角', pitch: 'E', freq: 329.63 },
                        { name: '徴', pitch: 'G', freq: 392.00 },
                        { name: '羽', pitch: 'A', freq: 440.00 },
                        { name: '宮', pitch: 'C', freq: 523.25 },
                    ]
                },
                india: {
                    id: 'india',
                    name: 'インド (ラーガ)',
                    description: 'レとラが半音下がる「バイラヴ」風。',
                    color: 'bg-purple-600',
                    notes: [
                        { name: 'Sa', pitch: 'C', freq: 261.63 },
                        { name: 're', pitch: 'Db', freq: 277.18 },
                        { name: 'Ga', pitch: 'E', freq: 329.63 },
                        { name: 'Ma', pitch: 'F', freq: 349.23 },
                        { name: 'Pa', pitch: 'G', freq: 392.00 },
                        { name: 'dha', pitch: 'Ab', freq: 415.30 },
                        { name: 'Ni', pitch: 'B', freq: 493.88 },
                        { name: 'Sa', pitch: 'C', freq: 523.25 },
                    ]
                },
                bluenote: {
                    id: 'bluenote',
                    name: 'ブルーノート',
                    description: 'ミ・ソ・シが半音下がったジャズ音階。',
                    color: 'bg-indigo-900',
                    notes: [
                        { name: 'ド', pitch: 'C', freq: 261.63 },
                        { name: 'ミ♭', pitch: 'Eb', freq: 311.13 },
                        { name: 'ファ', pitch: 'F', freq: 349.23 },
                        { name: 'ソ♭', pitch: 'Gb', freq: 369.99 },
                        { name: 'ソ', pitch: 'G', freq: 392.00 },
                        { name: 'シ♭', pitch: 'Bb', freq: 466.16 },
                        { name: 'ド(高)', pitch: 'C', freq: 523.25 },
                    ]
                }
            };

            // 12音階の基本データ (ピアノモード用) C3 - C5 (2 octaves + 1 note)
            const generatePianoKeys = () => {
                const keys = [];
                const baseFreq = 130.81; // C3
                const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                
                // 25音 (2オクターブ + 最後のド)
                for (let i = 0; i <= 24; i++) { 
                    const noteIndex = i % 12;
                    const octave = Math.floor(i / 12) + 3;
                    const freq = baseFreq * Math.pow(2, i / 12);
                    
                    // 現在のスケールに含まれる音かどうか判定
                    const currentScaleNotes = scales[activeScale].notes;
                    const myNoteName = noteNames[noteIndex];
                    
                    const normalize = (n) => {
                        const map = {'Db':'C#', 'Eb':'D#', 'Gb':'F#', 'Ab':'G#', 'Bb':'A#'};
                        return map[n] || n;
                    };

                    const isInScale = currentScaleNotes.some(n => normalize(n.pitch) === myNoteName);

                    // 音名表示用（スケール定義からわかりやすい名前を取得）
                    let displayName = myNoteName;
                    if (isInScale) {
                        const match = currentScaleNotes.find(n => normalize(n.pitch) === myNoteName);
                        if (match) displayName = match.name;
                    }

                    keys.push({
                        id: i,
                        note: myNoteName,
                        displayName: displayName,
                        octave: octave,
                        freq: freq,
                        isInScale: isInScale
                    });
                }
                return keys;
            };
            const pianoKeys = generatePianoKeys();

            const initAudioContext = () => {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!audioContextRef.current) {
                    audioContextRef.current = new AudioContext();
                }
                if (audioContextRef.current.state === 'suspended') {
                    audioContextRef.current.resume();
                }
            };

            const playTone = (freq, duration = 0.5) => {
                initAudioContext();
                const ctx = audioContextRef.current;
                const osc = ctx.createOscillator();
                const gainNode = ctx.createGain();

                osc.type = waveform;
                osc.frequency.setValueAtTime(freq, ctx.currentTime);

                const now = ctx.currentTime;
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(volume, now + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration);

                osc.connect(gainNode);
                gainNode.connect(ctx.destination);

                osc.start(now);
                osc.stop(now + duration);
            };

            const handlePlayTone = (freq, index, type = 'scale') => {
                playTone(freq, 0.6);
                if (type === 'scale') {
                    setPlayingNote(index);
                    setTimeout(() => setPlayingNote(null), 300);
                } else if (type === 'piano') {
                    setPlayingPianoKey(index);
                    setTimeout(() => setPlayingPianoKey(null), 300);
                }
                if (isRecording) {
                    const time = Date.now() - recordingStartTime;
                    setCurrentRecording(prev => [...prev, { freq, time }]);
                }
            };

            const toggleRecording = () => {
                if (isRecording) {
                    setIsRecording(false);
                    if (currentRecording.length > 0) {
                        const newRec = {
                            id: Date.now(),
                            date: new Date().toLocaleTimeString(),
                            scaleName: scales[activeScale].name,
                            notes: currentRecording
                        };
                        setRecordings(prev => [newRec, ...prev]);
                    }
                    setCurrentRecording([]);
                } else {
                    setIsRecording(true);
                    setRecordingStartTime(Date.now());
                    setCurrentRecording([]);
                }
            };

            const playRecording = (recNotes) => {
                recNotes.forEach(note => {
                    setTimeout(() => {
                        playTone(note.freq, 0.5);
                    }, note.time);
                });
            };

            const deleteRecording = (id) => {
                setRecordings(prev => prev.filter(r => r.id !== id));
            };

            const playFullScale = async () => {
                const notes = scales[activeScale].notes;
                const duration = 500;
                for (let i = 0; i < notes.length; i++) {
                    handlePlayTone(notes[i].freq, i, 'scale');
                    await new Promise(r => setTimeout(r, duration));
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 text-gray-800 font-sans pb-10">
                    <div className="max-w-5xl mx-auto bg-white shadow-xl overflow-hidden min-h-screen md:min-h-0 md:my-8 md:rounded-2xl">
                        
                        {/* Header */}
                        <div className="bg-slate-800 text-white p-4 md:p-6 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div>
                                <h1 className="text-xl md:text-3xl font-bold flex items-center gap-3">
                                    <Music className="w-6 h-6 md:w-8 md:h-8 text-yellow-400" />
                                    世界の音階 聴き比べ
                                </h1>
                                <p className="text-slate-300 mt-1 text-xs md:text-sm">
                                    録音機能 & ピアノモード付き
                                </p>
                            </div>
                            
                            <div className="bg-slate-700 p-1 rounded-lg flex text-sm font-bold">
                                <button 
                                    onClick={() => setMode('scale')}
                                    className={`px-4 py-2 rounded-md transition-all ${mode === 'scale' ? 'bg-white text-slate-900 shadow' : 'text-slate-300 hover:text-white'}`}
                                >
                                    スケール学習
                                </button>
                                <button 
                                    onClick={() => setMode('piano')}
                                    className={`px-4 py-2 rounded-md transition-all ${mode === 'piano' ? 'bg-white text-slate-900 shadow' : 'text-slate-300 hover:text-white'}`}
                                >
                                    ピアノ演奏
                                </button>
                            </div>
                        </div>

                        {/* Controls */}
                        <div className="p-4 bg-gray-100 border-b flex flex-wrap gap-4 justify-between items-center">
                            <div className="flex flex-wrap items-center gap-4">
                                <label className="flex items-center gap-2 text-sm font-semibold text-gray-600">
                                    <Volume2 className="w-4 h-4" />
                                    <input 
                                        type="range" min="0" max="0.5" step="0.01" 
                                        value={volume}
                                        onChange={(e) => setVolume(parseFloat(e.target.value))}
                                        className="w-24 accent-slate-600"
                                    />
                                </label>
                                <select 
                                    value={waveform} onChange={(e) => setWaveform(e.target.value)}
                                    className="border rounded px-2 py-1 text-sm focus:outline-none"
                                >
                                    <option value="triangle">フルート風</option>
                                    <option value="sine">サイン波</option>
                                    <option value="square">ゲーム風</option>
                                    <option value="sawtooth">バイオリン風</option>
                                </select>
                            </div>

                            <div className="flex items-center gap-2">
                                <button 
                                    onClick={toggleRecording}
                                    className={`flex items-center gap-2 px-4 py-1.5 rounded-full text-sm font-bold transition-colors shadow-sm
                                        ${isRecording 
                                            ? 'bg-red-500 text-white animate-pulse' 
                                            : 'bg-white text-red-500 border border-red-200 hover:bg-red-50'}`}
                                >
                                    {isRecording ? <Square className="w-4 h-4 fill-current" /> : <Mic className="w-4 h-4" />}
                                    {isRecording ? '録音停止' : '録音開始'}
                                </button>
                                {isRecording && (
                                    <span className="text-xs text-red-500 font-mono animate-pulse">● REC</span>
                                )}
                            </div>
                        </div>

                        <div className="flex flex-col md:flex-row">
                            {/* Sidebar */}
                            <div className="md:w-64 bg-slate-50 p-2 md:p-4 border-r border-gray-200 flex flex-row md:flex-col overflow-x-auto md:overflow-visible gap-2 no-scrollbar">
                                {Object.values(scales).map((scale) => (
                                    <button
                                        key={scale.id}
                                        onClick={() => setActiveScale(scale.id)}
                                        className={`flex-shrink-0 text-left px-4 py-3 rounded-lg transition-all duration-200 font-medium text-sm whitespace-nowrap md:whitespace-normal ${
                                            activeScale === scale.id 
                                                ? `${scale.color} text-white shadow-md transform scale-105` 
                                                : 'bg-white text-gray-600 hover:bg-gray-200'
                                        }`}
                                    >
                                        {scale.name}
                                    </button>
                                ))}
                            </div>

                            {/* Main Content */}
                            <div className="flex-1 p-4 md:p-6 bg-white min-h-[400px] flex flex-col">
                                
                                <div className="mb-6 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                                    <div>
                                        <h2 className={`text-2xl font-bold ${scales[activeScale].color.replace('bg-', 'text-')}`}>
                                            {scales[activeScale].name}
                                        </h2>
                                        <p className="text-gray-500 text-sm flex items-center gap-1 mt-1">
                                            <Info className="w-4 h-4" />
                                            {scales[activeScale].description}
                                        </p>
                                    </div>
                                    {mode === 'scale' && (
                                        <button 
                                            onClick={playFullScale}
                                            className="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-full text-sm font-bold shadow transition-transform active:scale-95"
                                        >
                                            <Play className="w-4 h-4" /> 全音再生
                                        </button>
                                    )}
                                </div>

                                {/* MODE 1: Scale Learning View */}
                                {mode === 'scale' && (
                                    <div className="grid grid-cols-4 md:grid-cols-8 gap-2 md:gap-4 mb-8">
                                        {scales[activeScale].notes.map((note, index) => (
                                            <button
                                                key={index}
                                                onMouseDown={() => handlePlayTone(note.freq, index, 'scale')}
                                                onTouchStart={(e) => { e.preventDefault(); handlePlayTone(note.freq, index, 'scale'); }}
                                                className={`
                                                    relative h-24 md:h-40 rounded-xl flex flex-col items-center justify-end p-2 transition-all duration-75 shadow-sm border-2 border-gray-100 select-none
                                                    active:scale-95 touch-manipulation
                                                    ${playingNote === index 
                                                        ? `${scales[activeScale].color} text-white ring-4 ring-opacity-30 ring-current` 
                                                        : 'bg-white hover:bg-gray-50 text-gray-800'
                                                    }
                                                `}
                                            >
                                                <div className="mb-auto mt-2 text-[10px] md:text-xs opacity-50 font-mono">{note.pitch}</div>
                                                <div className="text-lg md:text-xl font-bold mb-2">{note.name}</div>
                                            </button>
                                        ))}
                                    </div>
                                )}

                                {/* MODE 2: Piano View (Updated: Linear & Filtered) */}
                                {mode === 'piano' && (
                                    <div className="mb-8">
                                        <div className="text-center text-sm text-gray-400 mb-2">
                                            {scales[activeScale].name}に含まれる音のみ表示（2オクターブ）
                                        </div>
                                        <div className="overflow-x-auto pb-4 custom-scrollbar">
                                            <div className="flex gap-1 md:gap-2 min-w-max px-2 justify-center">
                                                {pianoKeys.filter(k => k.isInScale).map((key) => (
                                                    <button
                                                        key={key.id}
                                                        onMouseDown={() => handlePlayTone(key.freq, key.id, 'piano')}
                                                        onTouchStart={(e) => { e.preventDefault(); handlePlayTone(key.freq, key.id, 'piano'); }}
                                                        className={`
                                                            h-32 md:h-48 w-12 md:w-16 rounded-lg flex flex-col items-center justify-end p-2 transition-all duration-100 shadow-sm border border-gray-200
                                                            active:scale-95 touch-manipulation select-none
                                                            ${playingPianoKey === key.id 
                                                                ? `${scales[activeScale].color} text-white ring-2 ring-offset-2 ring-current` 
                                                                : 'bg-white hover:bg-gray-50 text-gray-800'
                                                            }
                                                        `}
                                                    >
                                                        <div className="mb-auto mt-2 text-[10px] md:text-xs opacity-50 font-mono">{key.note}{key.octave}</div>
                                                        <div className="text-sm md:text-lg font-bold mb-1 md:mb-2 whitespace-nowrap overflow-hidden text-ellipsis w-full text-center">
                                                            {key.displayName}
                                                        </div>
                                                        {/* Visual indication for key position */}
                                                        <div className="w-1 h-1 rounded-full bg-gray-300 mb-1"></div>
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Recordings List */}
                                {recordings.length > 0 && (
                                    <div className="mt-auto border-t pt-4">
                                        <h3 className="text-sm font-bold text-gray-500 mb-3 uppercase tracking-wider">録音履歴</h3>
                                        <div className="space-y-2 max-h-40 overflow-y-auto pr-2 custom-scrollbar">
                                            {recordings.map((rec) => (
                                                <div key={rec.id} className="flex items-center justify-between bg-gray-50 p-3 rounded-lg border border-gray-100 hover:border-gray-300 transition-colors">
                                                    <div className="flex items-center gap-3">
                                                        <div className={`w-2 h-2 rounded-full ${rec.scaleName.includes('インド') ? 'bg-purple-500' : 'bg-gray-400'}`}></div>
                                                        <div>
                                                            <div className="text-sm font-bold text-gray-700">{rec.scaleName}の演奏</div>
                                                            <div className="text-xs text-gray-400">{rec.date} • {rec.notes.length}音</div>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <button 
                                                            onClick={() => playRecording(rec.notes)}
                                                            className="p-2 text-slate-600 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors"
                                                            title="再生"
                                                        >
                                                            <Play className="w-4 h-4" />
                                                        </button>
                                                        <button 
                                                            onClick={() => deleteRecording(rec.id)}
                                                            className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors"
                                                            title="削除"
                                                        >
                                                            <Trash2 className="w-4 h-4" />
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MusicalScalesApp />);
    </script>
</body>
</html>
