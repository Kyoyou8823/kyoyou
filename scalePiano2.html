<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>世界の音階 聴き比べアプリ (Linear Layout)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            touch-action: manipulation;
            overscroll-behavior: none;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .custom-scrollbar::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen overflow-hidden flex flex-col">

    <div id="root" class="h-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const Play = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
        );
        const Stop = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="current" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>
        );
        const Square = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>
        );
        const Music = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
        );
        const Volume2 = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
        );
        const Info = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
        );
        const Mic = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
        );
        const Trash2 = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
        );

        const MusicalScalesApp = () => {
            const [activeScale, setActiveScale] = useState('major');
            const [instrumentType, setInstrumentType] = useState('triangle');
            const [volume, setVolume] = useState(0.3);
            const [playingNote, setPlayingNote] = useState(null);
            const [playingPianoKey, setPlayingPianoKey] = useState(null);
            const [mode, setMode] = useState('scale');
            
            // Recording State
            const [isRecording, setIsRecording] = useState(false);
            const [recordingStartTime, setRecordingStartTime] = useState(null);
            const [currentRecording, setCurrentRecording] = useState([]);
            const [recordings, setRecordings] = useState([]);
            const [playingRecordingId, setPlayingRecordingId] = useState(null);

            const audioContextRef = useRef(null);
            const playbackTimeoutsRef = useRef([]);

            // スケールデータ
            const scales = {
                major: {
                    id: 'major',
                    name: '西洋 (ドレミ)',
                    description: '一般的な長音階',
                    color: 'bg-blue-500',
                    notes: [
                        { name: 'ド', pitch: 'C', freq: 261.63 },
                        { name: 'レ', pitch: 'D', freq: 293.66 },
                        { name: 'ミ', pitch: 'E', freq: 329.63 },
                        { name: 'ファ', pitch: 'F', freq: 349.23 },
                        { name: 'ソ', pitch: 'G', freq: 392.00 },
                        { name: 'ラ', pitch: 'A', freq: 440.00 },
                        { name: 'シ', pitch: 'B', freq: 493.88 },
                        { name: 'ド(高)', pitch: 'C', freq: 523.25 },
                    ]
                },
                okinawa: {
                    id: 'okinawa',
                    name: '沖縄 (琉球)',
                    description: 'レとラを抜いた5音',
                    color: 'bg-orange-500',
                    notes: [
                        { name: 'ド', pitch: 'C', freq: 261.63 },
                        { name: 'ミ', pitch: 'E', freq: 329.63 },
                        { name: 'ファ', pitch: 'F', freq: 349.23 },
                        { name: 'ソ', pitch: 'G', freq: 392.00 },
                        { name: 'シ', pitch: 'B', freq: 493.88 },
                        { name: 'ド(高)', pitch: 'C', freq: 523.25 },
                    ]
                },
                china: {
                    id: 'china',
                    name: '中国 (五声)',
                    description: 'ファとシを抜いた5音',
                    color: 'bg-red-600',
                    notes: [
                        { name: '宮', pitch: 'C', freq: 261.63 },
                        { name: '商', pitch: 'D', freq: 293.66 },
                        { name: '角', pitch: 'E', freq: 329.63 },
                        { name: '徴', pitch: 'G', freq: 392.00 },
                        { name: '羽', pitch: 'A', freq: 440.00 },
                        { name: '宮', pitch: 'C', freq: 523.25 },
                    ]
                },
                india: {
                    id: 'india',
                    name: 'インド (ラーガ)',
                    description: 'レとラが半音下がる',
                    color: 'bg-purple-600',
                    notes: [
                        { name: 'Sa', pitch: 'C', freq: 261.63 },
                        { name: 're', pitch: 'Db', freq: 277.18 },
                        { name: 'Ga', pitch: 'E', freq: 329.63 },
                        { name: 'Ma', pitch: 'F', freq: 349.23 },
                        { name: 'Pa', pitch: 'G', freq: 392.00 },
                        { name: 'dha', pitch: 'Ab', freq: 415.30 },
                        { name: 'Ni', pitch: 'B', freq: 493.88 },
                        { name: 'Sa', pitch: 'C', freq: 523.25 },
                    ]
                },
                bluenote: {
                    id: 'bluenote',
                    name: 'ブルーノート',
                    description: 'ミ・ソ・シが半音下',
                    color: 'bg-indigo-900',
                    notes: [
                        { name: 'ド', pitch: 'C', freq: 261.63 },
                        { name: 'ミ♭', pitch: 'Eb', freq: 311.13 },
                        { name: 'ファ', pitch: 'F', freq: 349.23 },
                        { name: 'ソ♭', pitch: 'Gb', freq: 369.99 },
                        { name: 'ソ', pitch: 'G', freq: 392.00 },
                        { name: 'シ♭', pitch: 'Bb', freq: 466.16 },
                        { name: 'ド(高)', pitch: 'C', freq: 523.25 },
                    ]
                }
            };

            const generatePianoKeys = () => {
                const keys = [];
                const baseFreq = 130.81; // C3
                const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                
                for (let i = 0; i <= 24; i++) { 
                    const noteIndex = i % 12;
                    const octave = Math.floor(i / 12) + 3;
                    const freq = baseFreq * Math.pow(2, i / 12);
                    
                    const currentScaleNotes = scales[activeScale].notes;
                    const myNoteName = noteNames[noteIndex];
                    
                    const normalize = (n) => {
                        const map = {'Db':'C#', 'Eb':'D#', 'Gb':'F#', 'Ab':'G#', 'Bb':'A#'};
                        return map[n] || n;
                    };

                    const isInScale = currentScaleNotes.some(n => normalize(n.pitch) === myNoteName);

                    let displayName = myNoteName;
                    if (isInScale) {
                        const match = currentScaleNotes.find(n => normalize(n.pitch) === myNoteName);
                        if (match) displayName = match.name;
                    }

                    keys.push({
                        id: i,
                        note: myNoteName,
                        displayName: displayName,
                        octave: octave,
                        freq: freq,
                        isInScale: isInScale
                    });
                }
                return keys;
            };
            const pianoKeys = generatePianoKeys();

            const initAudioContext = () => {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!audioContextRef.current) {
                    audioContextRef.current = new AudioContext();
                }
                if (audioContextRef.current.state === 'suspended') {
                    audioContextRef.current.resume();
                }
            };

            const playTone = (freq, duration = 0.5) => {
                initAudioContext();
                const ctx = audioContextRef.current;
                const now = ctx.currentTime;
                
                const osc = ctx.createOscillator();
                osc.frequency.setValueAtTime(freq, now);

                const gainNode = ctx.createGain();
                
                let sourceNode = osc;
                let finalNode = gainNode;

                if (instrumentType === 'violin') {
                    osc.type = 'sawtooth';
                    const filter = ctx.createBiquadFilter();
                    filter.type = 'lowpass';
                    filter.frequency.setValueAtTime(2000, now);
                    filter.Q.value = 1;
                    
                    const lfo = ctx.createOscillator();
                    lfo.frequency.value = 6;
                    const lfoGain = ctx.createGain();
                    lfoGain.gain.value = 5;
                    lfo.connect(lfoGain);
                    lfoGain.connect(osc.frequency);
                    lfo.start(now);
                    lfo.stop(now + duration);

                    osc.connect(filter);
                    filter.connect(gainNode);

                    gainNode.gain.setValueAtTime(0, now);
                    gainNode.gain.linearRampToValueAtTime(volume, now + 0.1);
                    gainNode.gain.setValueAtTime(volume, now + duration - 0.1);
                    gainNode.gain.linearRampToValueAtTime(0.001, now + duration);

                } else if (instrumentType === 'sax') {
                    osc.type = 'sawtooth';
                    const filter = ctx.createBiquadFilter();
                    filter.type = 'lowpass';
                    filter.frequency.setValueAtTime(600, now);
                    filter.Q.value = 2; 

                    filter.frequency.linearRampToValueAtTime(1200, now + 0.05);
                    filter.frequency.exponentialRampToValueAtTime(600, now + duration);

                    osc.connect(filter);
                    filter.connect(gainNode);

                    gainNode.gain.setValueAtTime(0, now);
                    gainNode.gain.linearRampToValueAtTime(volume, now + 0.05);
                    gainNode.gain.exponentialRampToValueAtTime(volume * 0.7, now + 0.2);
                    gainNode.gain.linearRampToValueAtTime(0.001, now + duration);

                } else {
                    osc.type = instrumentType;
                    osc.connect(gainNode);

                    gainNode.gain.setValueAtTime(0, now);
                    gainNode.gain.linearRampToValueAtTime(volume, now + 0.02);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration);
                }

                gainNode.connect(ctx.destination);
                osc.start(now);
                osc.stop(now + duration);
            };

            const handlePlayTone = (freq, index, type = 'scale') => {
                const playDuration = (instrumentType === 'violin' || instrumentType === 'sax') ? 0.8 : 0.6;
                playTone(freq, playDuration);

                if (type === 'scale') {
                    setPlayingNote(index);
                    setTimeout(() => setPlayingNote(null), 300);
                } else if (type === 'piano') {
                    setPlayingPianoKey(index);
                    setTimeout(() => setPlayingPianoKey(null), 300);
                }
                
                if (isRecording) {
                    const time = Date.now() - recordingStartTime;
                    setCurrentRecording(prev => [...prev, { freq, time }]);
                }
            };

            const toggleRecording = () => {
                if (isRecording) {
                    setIsRecording(false);
                    if (currentRecording.length > 0) {
                        const newRec = {
                            id: Date.now(),
                            date: new Date().toLocaleTimeString(),
                            scaleName: scales[activeScale].name,
                            instrument: instrumentType,
                            notes: currentRecording
                        };
                        setRecordings(prev => [newRec, ...prev]);
                    }
                    setCurrentRecording([]);
                } else {
                    setIsRecording(true);
                    setRecordingStartTime(Date.now());
                    setCurrentRecording([]);
                }
            };

            const stopAllPlayback = () => {
                playbackTimeoutsRef.current.forEach(id => clearTimeout(id));
                playbackTimeoutsRef.current = [];
                setPlayingRecordingId(null);
            };

            const playRecording = (rec) => {
                stopAllPlayback();
                setPlayingRecordingId(rec.id);
                
                const lastNoteTime = rec.notes[rec.notes.length - 1].time;
                const endTimeout = setTimeout(() => {
                     if(playingRecordingId === rec.id) setPlayingRecordingId(null);
                }, lastNoteTime + 1000);
                playbackTimeoutsRef.current.push(endTimeout);

                rec.notes.forEach(note => {
                    const timeoutId = setTimeout(() => {
                        playTone(note.freq, 0.5);
                    }, note.time);
                    playbackTimeoutsRef.current.push(timeoutId);
                });
            };

            const deleteRecording = (id) => {
                if (playingRecordingId === id) stopAllPlayback();
                setRecordings(prev => prev.filter(r => r.id !== id));
            };

            const playFullScale = async () => {
                stopAllPlayback();
                const notes = scales[activeScale].notes;
                const duration = 500;
                for (let i = 0; i < notes.length; i++) {
                    handlePlayTone(notes[i].freq, i, 'scale');
                    await new Promise(r => setTimeout(r, duration));
                }
            };

            return (
                <div className="h-full flex flex-col bg-white">
                    {/* Header */}
                    <div className="bg-slate-800 text-white p-3 flex justify-between items-center shrink-0 shadow-md z-10">
                        <div className="flex items-center gap-3">
                            <h1 className="text-lg font-bold flex items-center gap-2">
                                <Music className="w-5 h-5 text-yellow-400" />
                                <span className="hidden sm:inline">世界の音階</span>
                            </h1>
                            
                            {/* モード切替タブ */}
                            <div className="bg-slate-700 p-1 rounded-lg flex text-xs font-bold">
                                <button 
                                    onClick={() => setMode('scale')}
                                    className={`px-3 py-1.5 rounded-md transition-all ${mode === 'scale' ? 'bg-white text-slate-900 shadow' : 'text-slate-300 hover:text-white'}`}
                                >
                                    学習
                                </button>
                                <button 
                                    onClick={() => setMode('piano')}
                                    className={`px-3 py-1.5 rounded-md transition-all ${mode === 'piano' ? 'bg-white text-slate-900 shadow' : 'text-slate-300 hover:text-white'}`}
                                >
                                    ピアノ
                                </button>
                            </div>
                        </div>

                        {/* 音量調整 */}
                         <div className="flex items-center gap-2 bg-slate-700/50 px-2 py-1 rounded-full">
                            <Volume2 className="w-4 h-4 text-slate-300" />
                            <input 
                                type="range" min="0" max="0.5" step="0.01" 
                                value={volume}
                                onChange={(e) => setVolume(parseFloat(e.target.value))}
                                className="w-20 accent-yellow-400 h-1.5"
                            />
                        </div>
                    </div>

                    {/* Controls Bar */}
                    <div className="bg-gray-100 border-b p-2 shrink-0 flex flex-wrap gap-2 items-center justify-between shadow-inner">
                        <div className="flex items-center gap-2 flex-1">
                            {/* 楽器選択 */}
                            <select 
                                value={instrumentType} onChange={(e) => setInstrumentType(e.target.value)}
                                className="border border-gray-300 rounded px-2 py-1.5 text-sm font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
                            >
                                <option value="triangle">フルート</option>
                                <option value="violin">バイオリン</option>
                                <option value="sax">サックス</option>
                                <option value="square">ゲーム</option>
                                <option value="sine">サイン波</option>
                            </select>

                            {/* スケール選択 (ピアノモード時のみ表示) */}
                            {mode === 'piano' && (
                                <select 
                                    value={activeScale} 
                                    onChange={(e) => setActiveScale(e.target.value)}
                                    className="border border-gray-300 rounded px-2 py-1.5 text-sm font-bold text-white bg-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    {Object.values(scales).map(s => (
                                        <option key={s.id} value={s.id}>{s.name}</option>
                                    ))}
                                </select>
                            )}
                        </div>

                        {/* 録音ボタン */}
                        <button 
                            onClick={toggleRecording}
                            className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold transition-all shadow-sm border
                                ${isRecording 
                                    ? 'bg-red-500 text-white border-red-600 animate-pulse ring-2 ring-red-300' 
                                    : 'bg-white text-red-500 border-red-200 hover:bg-red-50'}`}
                        >
                            {isRecording ? <Square className="w-3 h-3 fill-current" /> : <Mic className="w-3 h-3" />}
                            {isRecording ? '停止' : '録音'}
                        </button>
                    </div>

                    {/* Main Body */}
                    <div className="flex-1 flex overflow-hidden">
                        
                        {/* Sidebar (Scaleモード時のみ表示) */}
                        {mode === 'scale' && (
                            <div className="w-48 bg-slate-50 border-r border-gray-200 overflow-y-auto p-2 shrink-0 hidden md:block">
                                <div className="space-y-2">
                                    {Object.values(scales).map((scale) => (
                                        <button
                                            key={scale.id}
                                            onClick={() => setActiveScale(scale.id)}
                                            className={`w-full text-left px-3 py-2 rounded-lg transition-all text-sm font-medium ${
                                                activeScale === scale.id 
                                                    ? `${scale.color} text-white shadow` 
                                                    : 'bg-white text-gray-600 hover:bg-gray-200'
                                            }`}
                                        >
                                            {scale.name}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Content Area */}
                        <div className="flex-1 flex flex-col bg-white overflow-hidden relative">
                            
                            {/* Scale Mode View */}
                            {mode === 'scale' && (
                                <div className="p-4 overflow-y-auto h-full flex flex-col">
                                    {/* Mobile Scale Selector */}
                                    <div className="md:hidden mb-4 overflow-x-auto whitespace-nowrap pb-2 shrink-0">
                                        {Object.values(scales).map((scale) => (
                                            <button
                                                key={scale.id}
                                                onClick={() => setActiveScale(scale.id)}
                                                className={`inline-block mr-2 px-3 py-1.5 rounded-full text-sm font-bold ${
                                                    activeScale === scale.id 
                                                        ? `${scale.color} text-white` 
                                                        : 'bg-gray-100 text-gray-600'
                                                }`}
                                            >
                                                {scale.name}
                                            </button>
                                        ))}
                                    </div>

                                    <div className="mb-6 shrink-0">
                                        <h2 className={`text-2xl font-bold ${scales[activeScale].color.replace('bg-', 'text-')}`}>
                                            {scales[activeScale].name}
                                        </h2>
                                        <p className="text-gray-500 text-sm mt-1 mb-4">{scales[activeScale].description}</p>
                                        <button 
                                            onClick={playFullScale}
                                            className="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow mb-6"
                                        >
                                            <Play className="w-4 h-4" /> 全音再生
                                        </button>
                                    </div>

                                    {/* 音階ボタンエリア（横一列・高さ確保） */}
                                    <div className="flex-1 min-h-[200px] flex gap-2 items-end pb-8">
                                        {scales[activeScale].notes.map((note, index) => (
                                            <button
                                                key={index}
                                                onMouseDown={() => handlePlayTone(note.freq, index, 'scale')}
                                                onTouchStart={(e) => { e.preventDefault(); handlePlayTone(note.freq, index, 'scale'); }}
                                                className={`
                                                    flex-1 h-full rounded-xl flex flex-col items-center justify-end p-2 transition-all shadow-sm border-2 border-gray-100 select-none
                                                    active:scale-95 touch-manipulation min-w-0
                                                    ${playingNote === index 
                                                        ? `${scales[activeScale].color} text-white ring-4 ring-opacity-30 ring-current` 
                                                        : 'bg-white hover:bg-gray-50 text-gray-800'
                                                    }
                                                `}
                                            >
                                                <div className="mb-auto mt-4 text-xs opacity-50 font-mono">{note.pitch}</div>
                                                <div className="text-xl md:text-3xl font-bold mb-4">{note.name}</div>
                                            </button>
                                        ))}
                                    </div>

                                    {/* Scale Mode Recordings */}
                                    {recordings.length > 0 && (
                                        <div className="mt-auto border-t pt-4 shrink-0">
                                            <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2 flex justify-between">
                                                <span>録音履歴</span>
                                                {playingRecordingId && (
                                                    <button onClick={stopAllPlayback} className="text-xs text-red-500 font-bold">全停止</button>
                                                )}
                                            </h3>
                                            <div className="space-y-1 max-h-32 overflow-y-auto custom-scrollbar">
                                                {recordings.map((rec) => (
                                                    <div key={rec.id} className={`flex items-center justify-between p-2 rounded text-sm transition-colors ${playingRecordingId === rec.id ? 'bg-blue-50 text-blue-700' : 'bg-gray-50 hover:bg-gray-100 border border-gray-100'}`}>
                                                        <div className="truncate flex-1 pr-2">
                                                            <span className="font-bold">{rec.scaleName}</span>
                                                            <span className="text-xs text-gray-500 ml-2">{rec.notes.length}音</span>
                                                        </div>
                                                        <div className="flex shrink-0">
                                                            <button onClick={() => playRecording(rec)} className="p-1 text-blue-500 hover:bg-blue-100 rounded"><Play className="w-4 h-4" /></button>
                                                            <button onClick={() => deleteRecording(rec.id)} className="p-1 text-gray-400 hover:text-red-500 hover:bg-red-100 rounded ml-1"><Trash2 className="w-4 h-4" /></button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* Piano Mode View */}
                            {mode === 'piano' && (
                                <div className="flex flex-col h-full">
                                    {/* Info & History Area (Top) */}
                                    <div className="flex-1 overflow-y-auto p-4 bg-gray-50 border-b relative">
                                        
                                        {/* 現在のスケール情報 */}
                                        <div className="text-center mb-6">
                                            <h2 className="text-xl font-bold text-gray-700">{scales[activeScale].name}</h2>
                                            <p className="text-xs text-gray-400 mt-1">
                                                {scales[activeScale].description} (スケール音のみ有効化)
                                            </p>
                                        </div>

                                        {/* 録音履歴 (Pianoモード用) */}
                                        {recordings.length > 0 && (
                                            <div className="max-w-md mx-auto bg-white rounded-lg shadow-sm border p-3">
                                                <div className="flex justify-between items-center mb-2">
                                                    <h3 className="text-xs font-bold text-gray-400 uppercase">録音履歴</h3>
                                                    {playingRecordingId && (
                                                        <button onClick={stopAllPlayback} className="text-xs text-red-500 font-bold">全停止</button>
                                                    )}
                                                </div>
                                                <div className="space-y-1 max-h-32 overflow-y-auto custom-scrollbar">
                                                    {recordings.map((rec) => (
                                                        <div key={rec.id} className={`flex items-center justify-between p-2 rounded text-sm transition-colors ${playingRecordingId === rec.id ? 'bg-blue-50 text-blue-700' : 'hover:bg-gray-50'}`}>
                                                            <div className="truncate flex-1 pr-2">
                                                                <span className="font-bold">{rec.scaleName}</span>
                                                                <span className="text-xs text-gray-400 ml-2">{rec.date}</span>
                                                            </div>
                                                            <div className="flex shrink-0">
                                                                <button onClick={() => playRecording(rec)} className="p-1 hover:bg-blue-100 rounded text-slate-600"><Play className="w-4 h-4" /></button>
                                                                <button onClick={() => deleteRecording(rec.id)} className="p-1 hover:bg-red-100 rounded text-gray-400 hover:text-red-500 ml-1"><Trash2 className="w-4 h-4" /></button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* Keyboard Area (Bottom - Full Width) */}
                                    <div className="h-1/2 min-h-[200px] bg-gray-200 flex items-end justify-center pb-0 px-0 shadow-inner w-full relative">
                                        {/* Keyboard Container */}
                                        <div className="w-full h-full flex">
                                            {pianoKeys.filter(k => k.isInScale).map((key) => (
                                                <button
                                                    key={key.id}
                                                    onMouseDown={() => handlePlayTone(key.freq, key.id, 'piano')}
                                                    onTouchStart={(e) => { e.preventDefault(); handlePlayTone(key.freq, key.id, 'piano'); }}
                                                    className={`
                                                        flex-1 relative group border-r border-gray-300 last:border-r-0
                                                        transition-colors duration-75 ease-out touch-manipulation select-none
                                                        flex flex-col justify-end items-center pb-4
                                                        ${playingPianoKey === key.id 
                                                            ? `${scales[activeScale].color} text-white` 
                                                            : 'bg-white hover:bg-gray-50 text-gray-600'
                                                        }
                                                    `}
                                                >
                                                    <span className={`text-xl md:text-2xl font-bold mb-2 ${playingPianoKey === key.id ? 'scale-110' : ''}`}>
                                                        {key.displayName}
                                                    </span>
                                                    <span className="text-[10px] opacity-40 font-mono absolute top-2">{key.note}{key.octave}</span>
                                                    
                                                    {/* Key Marker */}
                                                    <div className={`w-1.5 h-1.5 rounded-full ${playingPianoKey === key.id ? 'bg-white' : 'bg-gray-300'}`}></div>
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MusicalScalesApp />);
    </script>
</body>
</html>
